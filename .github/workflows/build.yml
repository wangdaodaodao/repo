name: æ„å»ºä»“åº“ç´¢å¼•

on:
  push:
    branches: [ main, master ]
    paths:
      - 'debs/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-dev bzip2
    
    - name: ç”Ÿæˆ Packages æ–‡ä»¶
      run: |
        echo "ğŸ“¦ å¼€å§‹ç”Ÿæˆ Packages æ–‡ä»¶..."
        dpkg-scanpackages -m debs /dev/null > Packages
        echo "âœ… Packages æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
        
    - name: å‹ç¼© Packages æ–‡ä»¶
      run: |
        echo "ğŸ—œï¸  å‹ç¼© Packages æ–‡ä»¶..."
        bzip2 -fks Packages
        echo "âœ… Packages.bz2 ç”Ÿæˆå®Œæˆ"
        
    - name: æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
      run: |
        PACKAGE_COUNT=$(grep -c "^Package:" Packages || echo "0")
        echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
        echo "   - æ’ä»¶æ•°é‡: $PACKAGE_COUNT"
        echo "   - Packages å¤§å°: $(ls -lh Packages | awk '{print $5}')"
        echo "   - Packages.bz2 å¤§å°: $(ls -lh Packages.bz2 | awk '{print $5}')"
    
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        git add Packages Packages.bz2
        git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° Packages ç´¢å¼•æ–‡ä»¶" && echo "CHANGES_MADE=true" >> $GITHUB_ENV)
        
    - name: æ¨é€æ›´æ”¹
      if: env.CHANGES_MADE == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
